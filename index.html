<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Movimento do Aeroporto</title>
  <style>
    /* CSS Reset & base */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0; padding: 0; font-family: 'Poppins', sans-serif;
      background: #ffffff; color: #6b7280; /* neutral gray */
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body.dark {
      background: #1f2937; /* dark gray bg */
      color: #d1d5db; /* light gray text */
    }

    /* Header Sticky */
    header#app-header {
      position: sticky;
      top: 0;
      background: #fff;
      color: #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.07);
      z-index: 1000;
      user-select: none;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body.dark header#app-header {
      background: #374151;
      color: #f3f4f6;
    }
    #logo {
      font-weight: 800;
      font-size: 1.5rem;
      letter-spacing: 0.03em;
      color: #3b82f6;
      user-select: text;
    }
    #header-title {
      font-weight: 700;
      font-size: 1.75rem;
      user-select: text;
      color: inherit;
    }
    #header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    button#theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.3rem;
      color: currentColor;
      transition: color 0.3s ease;
    }
    button#theme-toggle:hover {
      color: #2563eb;
    }
    #current-time {
      font-weight: 600;
      font-size: 1rem;
      color: #6b7280;
      user-select: none;
    }
    body.dark #current-time {
      color: #d1d5db;
    }

    /* Container layout */
    #app-container {
      display: flex;
      flex: 1;
      max-width: 1200px;
      margin: 1rem auto 1.5rem;
      box-shadow: 0 6px 20px rgb(0 0 0 / 0.05);
      border-radius: 0.75rem;
      overflow: hidden;
      background: #fff;
      user-select: none;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body.dark #app-container {
      background: #111827;
      color: #d1d5db;
    }

    /* Terminal Tabs */
    #terminal-tabs {
      display: flex;
      border-bottom: 2px solid #e5e7eb; /* light gray */
      background: #f9fafb;
      user-select: none;
      user-drag: none;
    }
    body.dark #terminal-tabs {
      background: #374151;
      border-color: #4b5563;
    }
    #terminal-tabs button {
      flex: 1;
      padding: 1.25rem 0;
      font-weight: 700;
      font-size: 1.25rem;
      border: none;
      background: transparent;
      cursor: pointer;
      color: #6b7280;
      transition: color 0.3s ease, border-bottom-color 0.3s ease;
      border-bottom: 3px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      user-select: none;
    }
    #terminal-tabs button[aria-selected="true"] {
      color: #111827;
      border-bottom-color: #3b82f6; /* blue */
    }
    body.dark #terminal-tabs button[aria-selected="true"] {
      color: #d1d5db;
      border-bottom-color: #60a5fa;
    }
    #terminal-tabs button:hover:not([aria-selected="true"]) {
      color: #2563eb;
    }
    body.dark #terminal-tabs button:hover:not([aria-selected="true"]) {
      color: #93c5fd;
    }

    /* Tabs icon svg */
    .tab-icon {
      stroke: currentColor;
      stroke-width: 1.7;
      width: 18px; height: 18px;
      user-select: none;
    }

    /* Terminal Content Area */
    #terminal-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      background: #fefefe;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body.dark #terminal-content {
      background: #1f2937;
      color: #d1d5db;
    }
    /* Positions grid */
    .positions-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-gap: 1.25rem;
      padding: 1.25rem 1.5rem;
      overflow-y: auto;
      height: calc(100vh - 210px);
      background: #f3f4f6;
      border-radius: 0 0 0.75rem 0.75rem;
      user-select: none;
      user-drag: none;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body.dark .positions-grid {
      background: #374151;
      color: #d1d5db;
    }
    .position-card {
      background: #fff;
      border-radius: 0.75rem;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.07);
      padding: 0.75rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.9rem;
      color: #374151;
      user-select: none;
      cursor: pointer;
      transition: box-shadow 0.4s cubic-bezier(0.4,0,0.2,1), transform 0.3s ease;
      position: relative;
      outline-offset: 2px;
    }
    body.dark .position-card {
      background: #2563eb;
      color: #e0e7ff;
      box-shadow: 0 2px 6px rgb(96 165 250 / 0.7);
    }
    .position-card:hover,
    .position-card:focus-visible {
      box-shadow: 0 8px 20px rgb(59 130 246 / 0.35);
      transform: scale(1.05);
      z-index: 10;
      outline: none;
    }
    .position-card .pos-label {
      font-weight: 700;
      margin-bottom: 0.35rem;
      color: #111827;
      user-select: text;
    }
    body.dark .position-card .pos-label {
      color: #e0e7ff;
    }
    .position-card .aircraft-id {
      font-weight: 700;
      font-size: 1rem;
      color: #2563eb;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 100%;
      user-select: text;
    }
    body.dark .position-card .aircraft-id {
      color: #dbeafe;
    }
    .position-empty {
      color: #9ca3af;
      font-style: italic;
      user-select: none;
    }
    body.dark .position-empty {
      color: #93c5fd;
      font-style: italic;
    }

    /* Side panel */
    #side-panel {
      width: 320px;
      border-left: 1px solid #e5e7eb;
      background: #fff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      user-select: none;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body.dark #side-panel {
      border-color: #4b5563;
      background: #111827;
      color: #d1d5db;
    }
    #side-panel h2 {
      font-weight: 700;
      font-size: 1.5rem;
      padding: 1rem 1.5rem 0.5rem;
      color: #111827;
      user-select: text;
    }
    body.dark #side-panel h2 {
      color: #d1d5db;
    }
    #flight-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      user-select: none;
    }
    body.dark #flight-tabs {
      border-color: #4b5563;
    }
    #flight-tabs button {
      flex: 1;
      padding: 0.75rem 0;
      font-weight: 600;
      background: transparent;
      border: none;
      cursor: pointer;
      color: #6b7280;
      font-size: 1.125rem;
      letter-spacing: 0.03em;
      border-bottom: 3px solid transparent;
      transition: all 0.25s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }
    #flight-tabs button[aria-selected="true"] {
      color: #111827;
      border-bottom-color: #3b82f6;
      font-weight: 700;
    }
    body.dark #flight-tabs button[aria-selected="true"] {
      color: #dbeafe;
      border-bottom-color: #60a5fa;
    }
    #flight-tabs button:hover:not([aria-selected="true"]) {
      color: #2563eb;
    }
    body.dark #flight-tabs button:hover:not([aria-selected="true"]) {
      color: #93c5fd;
    }

    /* Flights list */
    #flight-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem 1.25rem 1rem;
      user-select: none;
      user-drag: none;
    }
    /* Flight card */
    .flight-card {
      background: #f9fafb;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.05);
      margin-bottom: 0.75rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      user-select: none;
      outline-offset: 2px;
      position: relative;
    }
    body.dark .flight-card {
      background: #2563eb;
      box-shadow: 0 2px 10px rgb(96 165 250 / 0.7);
      color: #e0e7ff;
    }
    .flight-card:hover,
    .flight-card:focus-visible {
      background-color: #e0e7ff;
      box-shadow: 0 4px 10px rgb(59 130 246 / 0.25);
      color: #111827;
      outline: none;
    }
    body.dark .flight-card:hover,
    body.dark .flight-card:focus-visible {
      background-color: #3b82f6;
      box-shadow: 0 6px 20px rgb(191 219 254 / 0.75);
      color: #fff;
      outline: none;
    }
    .flight-header {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      color: inherit;
      font-size: 1.125rem;
      user-select: text;
    }
    .flight-info {
      font-size: 0.95rem;
      color: #6b7280;
      margin-top: 0.3rem;
      user-select: text;
    }
    body.dark .flight-info {
      color: #d1d5db;
    }
    .flight-status {
      margin-top: 0.35rem;
      font-weight: 600;
      padding: 0.2rem 0.7rem;
      border-radius: 0.5rem;
      width: fit-content;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      user-select: none;
      display: inline-block;
    }
    .status-confirmed {
      background-color: #dbeafe;
      color: #2563eb;
    }
    body.dark .status-confirmed {
      background-color: #60a5fa;
      color: #fefefe;
    }
    .status-delayed {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    body.dark .status-delayed {
      background-color: #fca5a5;
      color: #630000;
    }
    .status-cancelled {
      background-color: #f3f4f6;
      color: #6b7280;
      font-style: italic;
    }
    body.dark .status-cancelled {
      background-color: #4b5563;
      color: #9ca3af;
      font-style: italic;
    }

    /* Status dropdown inside flight card */
    .flight-status-select {
      margin-top: 0.5rem;
      border-radius: 0.5rem;
      padding: 0.25rem 0.5rem;
      border: 1px solid #d1d5db;
      font-family: 'Poppins', sans-serif;
      font-size: 0.85rem;
      color: #111827;
      cursor: pointer;
      transition: border-color 0.3s ease;
      user-select: text;
      width: 100%;
      max-width: 180px;
    }
    body.dark .flight-status-select {
      border-color: #60a5fa;
      background: #1e40af;
      color: #fefefe;
    }
    .flight-status-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
    }

    /* Modal backdrop */
    #modal-backdrop {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background-color: rgba(0,0,0,0.36);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      user-select: none;
      animation: fadein 0.32s ease forwards;
    }
    @keyframes fadein {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    /* Modal content */
    #modal {
      background: #fff;
      border-radius: 0.75rem;
      max-width: 400px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1.5rem 2rem 1.5rem 2rem;
      user-select: text;
      box-shadow: 0 10px 25px rgb(0 0 0 / 0.15);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      animation: slideup 0.4s cubic-bezier(0.4,0,0.2,1) forwards;
      outline: none;
    }
    body.dark #modal {
      background: #2563eb;
      color: #fefefe;
    }
    @keyframes slideup {
      from {
        opacity: 0;
        transform: translateY(20px);
      } to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    #modal h3 {
      margin: 0 0 1rem 0;
      font-weight: 800;
      font-size: 1.6rem;
      color: #111827;
      user-select: text;
    }
    body.dark #modal h3 {
      color: #f3f4f6;
    }
    #modal label {
      font-weight: 600;
      margin-bottom: 0.6rem;
      display: block;
      user-select: text;
    }
    #modal select,
    #modal input[type="time"] {
      width: 100%;
      padding: 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      transition: border-color 0.3s ease;
      color: #111827;
      user-select: text;
    }
    body.dark #modal select,
    body.dark #modal input[type="time"] {
      border-color: #60a5fa;
      background: #1e40af;
      color: #fefefe;
    }
    #modal select:focus,
    #modal input[type="time"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
    }
    #modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1rem;
    }
    #modal-buttons button {
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 0.65rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.25s ease;
      user-select: none;
      flex: none;
    }
    #modal-buttons button:hover,
    #modal-buttons button:focus-visible {
      background-color: #2563eb;
      outline: none;
    }
    #modal-buttons button.cancel-btn {
      background-color: #9ca3af;
    }
    #modal-buttons button.cancel-btn:hover,
    #modal-buttons button.cancel-btn:focus-visible {
      background-color: #6b7280;
      outline: none;
    }

    /* Scrollbar for side panel and positions */
    #flight-list::-webkit-scrollbar,
    .positions-grid::-webkit-scrollbar {
      width: 6px;
    }
    #flight-list::-webkit-scrollbar-thumb,
    .positions-grid::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 3px;
    }
    body.dark #flight-list::-webkit-scrollbar-thumb,
    body.dark .positions-grid::-webkit-scrollbar-thumb {
      background-color: #60a5fa;
    }

    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    .tooltip:hover .tooltiptext,
    .tooltip:focus-visible .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .tooltiptext {
      visibility: hidden;
      width: max-content;
      max-width: 280px;
      background-color: black;
      color: #fff;
      text-align: center;
      border-radius: 0.25rem;
      padding: 0.4rem 0.75rem;
      position: absolute;
      z-index: 10;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85rem;
      user-select: none;
      pointer-events: none;
    }

    /* Snackbar/Toast */
    #snackbar {
      visibility: hidden;
      min-width: 200px;
      background-color: #2563eb;
      color: #fff;
      text-align: center;
      border-radius: 0.5rem;
      padding: 1rem 2rem;
      position: fixed;
      z-index: 12000;
      left: 50%;
      bottom: 2rem;
      transform: translateX(-50%);
      box-shadow: 0 6px 20px rgb(37 99 235 / 0.6);
      font-size: 1rem;
      user-select: none;
      opacity: 0;
      transition: opacity 0.5s ease, visibility 0.5s;
    }
    #snackbar.show {
      visibility: visible;
      opacity: 1;
    }
    body.dark #snackbar {
      background-color: #60a5fa;
      color: #111827;
      box-shadow: 0 6px 20px rgb(96 165 250 / 0.9);
    }

    /* Filter header in side panel */
    #side-panel-filters {
      padding: 0.5rem 1.25rem;
      border-top: 1px solid #e5e7eb;
      user-select: none;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    body.dark #side-panel-filters {
      border-color: #4b5563;
    }
    #side-panel-filters label {
      font-weight: 600;
      font-size: 0.85rem;
      color: #6b7280;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    body.dark #side-panel-filters label {
      color: #d1d5db;
    }
    #side-panel-filters input[type="checkbox"] {
      margin-right: 0.3rem;
      cursor: pointer;
      user-select: none;
    }

    /* Update button */
    #update-flights-btn {
      margin-left: 1rem;
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
      font-size: 0.9rem;
      align-self: center;
    }
    #update-flights-btn:hover,
    #update-flights-btn:focus-visible {
      background-color: #2563eb;
      outline: none;
    }
    body.dark #update-flights-btn {
      background-color: #60a5fa;
      color: #111827;
    }
    body.dark #update-flights-btn:hover,
    body.dark #update-flights-btn:focus-visible {
      background-color: #3b82f6;
    }

  </style>
</head>
<body>
  <header id="app-header" role="banner">
    <div id="logo" aria-label="Logo do Aeroporto">✈️ AeroControl</div>
    <div id="header-title" aria-level="1" role="heading">Controle de Movimento do Aeroporto</div>
    <div id="header-actions">
      <div id="current-time" aria-live="polite" aria-atomic="true" aria-label="Horário local"></div>
      <button id="theme-toggle" aria-pressed="false" aria-label="Alternar tema claro e escuro" title="Alternar tema claro e escuro" tabindex="0">🌙</button>
    </div>
  </header>

  <div id="app-container" role="main" aria-label="Controle de Movimento do Aeroporto">
    <div style="flex:1; display:flex; flex-direction:column; min-width:0;">
      <nav id="terminal-tabs" role="tablist" aria-label="Terminais do aeroporto"></nav>
      <section id="terminal-content" tabindex="0"></section>
    </div>
    <aside id="side-panel" aria-label="Painel lateral de voos">
      <h2>Voos</h2>
      <nav id="flight-tabs" role="tablist" aria-label="Categorias de voos">
        <button role="tab" id="tab-arrivals" aria-controls="panel-arrivals" aria-selected="true" tabindex="0" aria-label="Mostrar voos de pouso">✈️ Pousos</button>
        <button role="tab" id="tab-departures" aria-controls="panel-departures" aria-selected="false" tabindex="-1" aria-label="Mostrar voos de decolagem">🛫 Decolagens</button>
        <button id="update-flights-btn" type="button" aria-label="Atualizar lista de voos" title="Atualizar lista de voos">↻ Atualizar</button>
      </nav>
      <div id="side-panel-filters" aria-label="Filtros de status de voos" role="region">
        <label><input type="checkbox" name="status-filter" value="Confirmed" checked> Confirmed</label>
        <label><input type="checkbox" name="status-filter" value="Delayed" checked> Delayed</label>
        <label><input type="checkbox" name="status-filter" value="Cancelled"> Cancelled</label>
      </div>
      <div id="flight-list" role="tabpanel" aria-labelledby="tab-arrivals" tabindex="0" style="overflow-y:auto;"></div>
    </aside>
  </div>

  <!-- Modal -->
  <div id="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div id="modal" tabindex="-1">
      <h3 id="modal-title"></h3>
      <div id="modal-content"></div>
      <div id="modal-buttons">
        <button id="modal-confirm-btn">Confirmar</button>
        <button id="modal-cancel-btn" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Snackbar -->
  <div id="snackbar" role="alert" aria-live="assertive" aria-atomic="true"></div>

<script>
  'use strict';
  // Constants e configurações
  const TERMINAL_COUNT = 10;
  const POSITIONS_PER_TERMINAL = 36;
  const LANDING_RUNWAYS = ['Pista 1', 'Pista 2'];
  const DEPARTURE_RUNWAY_MAP = {
    'TPS1': 'Pista 1',
    'TPS2': 'Pista 1',
    'TPS3': 'Pista 1',
    'TPS4': 'Pista 1',
    'TPS5': 'Pista 1',
    'TPS6': 'Pista 2',
    'TPS7': 'Pista 2',
    'TPS8': 'Pista 2',
    'TPS9': 'Pista 2',
    'TPS10': 'Pista 2'
  };

  const LANDING_STATUS = [
    'Scheduled','Confirmed','Landing','Landed','Deplaning','Finished',
    'Delayed','Cancelled'
  ];
  const DEPARTURE_STATUS = [
    'Scheduled','Check-in Opened','Boarding','Boarding Now','Last Call',
    'Confirmed','Taking Off','Finished',
    'Delayed','Cancelled'
  ];

  // Dados simulados
  let flights = [
    {id: 'AV101', airline:'Azul', aircraft:'Airbus A320', origin:'GRU', destination:'SBGR',
      terminal:'TPS1', position:null, landingTime:new Date(Date.now() + 30*60000),
      departureTime:new Date(Date.now() + 180*60000), frequency: 'Diário', type: 'landing',
      status: 'Scheduled', regNumber: null, cancelledTimestamp: null },
    {id: 'EM777', airline:'Emirates', aircraft:'B77W', origin:'DXB', destination:'SBGR',
      terminal:'TPS5', position:null,
      landingTime:new Date(Date.now() + 30*60000),
      departureTime:new Date(Date.now() + 360*60000),
      frequency: 'Semanal', nextFlightDay: new Date(Date.now() + 7*24*3600*1000).getDay(),
      type: 'landing', status: 'Confirmed', regNumber: null, cancelledTimestamp: null },
    {id: 'JJ404', airline:'LATAM', aircraft:'B738', origin:'SCL', destination:'SBGR',
      terminal:'TPS9', position:null, landingTime:new Date(Date.now() + 10*60000),
      departureTime:new Date(Date.now() + 150*60000), frequency: 'Diário', type: 'landing',
      status: 'Delayed', regNumber: null, cancelledTimestamp: null },
    {id: 'GOL221', airline:'Gol', aircraft:'B737', origin:'VCP', destination:'SBGR',
      terminal:'TPS3', position:null, landingTime:new Date(Date.now() + 90*60000),
      departureTime:new Date(Date.now() + 210*60000), frequency: 'Diário', type: 'landing',
      status: 'Cancelled', regNumber: null, cancelledTimestamp: null },
    {id: 'AV101D', airline:'Azul', aircraft:'Airbus A320', origin:'SBGR', destination:'GRU',
      terminal:'TPS5', position:'TPS5-01', landingTime:null,
      departureTime:new Date(Date.now() + 40*60000), frequency: 'Diário',
      type: 'departure', status: 'Scheduled', regNumber: 'REG1001', cancelledTimestamp: null },
    {id: 'EM777D', airline:'Emirates', aircraft:'B77W', origin:'SBGR', destination:'DXB',
      terminal:'TPS6', position:'TPS6-05', landingTime:null,
      departureTime:new Date(Date.now() + 240*60000), frequency: 'Semanal',
      type: 'departure', status: 'Scheduled', regNumber: 'REG2002', cancelledTimestamp: null }
  ];

  // Variáveis de estado e DOM
  let currentTerminalIndex = 0;
  let currentFlightTab = 'arrivals'; // arrivals or departures
  let landingQueue = [];
  let lastLandingTime = 0;
  const terminalTabs = document.getElementById('terminal-tabs');
  const terminalContent = document.getElementById('terminal-content');
  const flightTabs = document.getElementById('flight-tabs');
  const flightList = document.getElementById('flight-list');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalContent = document.getElementById('modal-content');
  const modalConfirmBtn = document.getElementById('modal-confirm-btn');
  const modalCancelBtn = document.getElementById('modal-cancel-btn');
  const snackbar = document.getElementById('snackbar');
  const themeToggleBtn = document.getElementById('theme-toggle');
  const currentTimeEl = document.getElementById('current-time');
  const updateFlightsBtn = document.getElementById('update-flights-btn');
  const statusFilters = [...document.querySelectorAll('#side-panel-filters input[type=checkbox]')];

  /* Helper: Icons SVG */
  const icons = {
    terminal: `<svg aria-hidden="true" class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <rect x="2" y="4" width="20" height="16" rx="2" ry="2"/>
      <path d="M8 8h8M8 12h8M8 16h8"/>
    </svg>`,
    arrivals: `<svg aria-hidden="true" class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path d="M18 12H6m6-6v12"/>
    </svg>`,
    departures: `<svg aria-hidden="true" class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path d="M6 12h12m-6 6V6"/>
    </svg>`
  };

  function showSnackbar(message) {
    snackbar.textContent = message;
    snackbar.classList.add('show');
    setTimeout(() => snackbar.classList.remove('show'), 3500);
  }

  // Cria abas dos terminais com icon
  function createTerminalTabs() {
    for(let i=0; i < TERMINAL_COUNT; i++) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.innerHTML = `${icons.terminal} TPS${i+1}`;
      btn.setAttribute('role', 'tab');
      btn.setAttribute('aria-selected', i === currentTerminalIndex ? 'true' : 'false');
      btn.setAttribute('tabindex', i === currentTerminalIndex ? '0' : '-1');
      btn.id = `terminal-tab-${i}`;
      btn.dataset.index = i;
      btn.addEventListener('click', () => switchTerminal(i));
      terminalTabs.appendChild(btn);
    }
  }

  function switchTerminal(index) {
    if(index === currentTerminalIndex) return;
    const prevBtn = terminalTabs.querySelector('[aria-selected="true"]');
    if(prevBtn) {
      prevBtn.setAttribute('aria-selected', 'false');
      prevBtn.setAttribute('tabindex', '-1');
    }
    const newBtn = terminalTabs.querySelector(`[data-index="${index}"]`);
    if(newBtn) {
      newBtn.setAttribute('aria-selected', 'true');
      newBtn.setAttribute('tabindex', '0');
      newBtn.focus();
    }
    currentTerminalIndex = index;
    renderPositions();
  }

  function renderPositions() {
    const terminalId = `TPS${currentTerminalIndex+1}`;
    terminalContent.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'positions-grid';
    const flightsInTerminal = flights.filter(f => f.position && f.terminal === terminalId);
    for(let i=1; i<=POSITIONS_PER_TERMINAL; i++) {
      const posId = `${terminalId}-${String(i).padStart(2,'0')}`;
      const posCard = document.createElement('div');
      posCard.className = 'position-card';
      posCard.setAttribute('tabindex', '0');
      posCard.dataset.positionId = posId;
      posCard.innerHTML = `<div class="pos-label">${posId}</div>`;
      const flightOnPos = flightsInTerminal.find(f => f.position === posId);
      if(flightOnPos) {
        posCard.innerHTML += `<div class="aircraft-id">${flightOnPos.regNumber || flightOnPos.id}</div>`;
        posCard.title = `Aeronave: ${flightOnPos.aircraft}\nVoo: ${flightOnPos.id}\nStatus: ${flightOnPos.status}`;
      } else {
        posCard.classList.add('position-empty');
        posCard.innerHTML += `<div class="aircraft-id">Vazia</div>`;
        posCard.title = `Posição livre`;
      }
      posCard.addEventListener('click', () => { handlePositionClick(posCard, flightOnPos); });
      grid.appendChild(posCard);
    }
    terminalContent.appendChild(grid);
  }

  function handlePositionClick(posCard, flight) {
    if(flight) {
      openMoveAircraftModal(flight);
    } else {
      showSnackbar('Posição vazia selecionada');
    }
  }

  function openMoveAircraftModal(flight) {
    modalTitle.textContent = `Mover Aeronave - Voo ${flight.id}`;
    modalContent.innerHTML = '';
    const select = document.createElement('select');
    const terminalId = `TPS${currentTerminalIndex+1}`;
    let emptyPositionsCount = 0;
    for(let i=1; i<=POSITIONS_PER_TERMINAL; i++) {
      const posId = `${terminalId}-${String(i).padStart(2,'0')}`;
      const occupied = flights.some(f => f.position === posId);
      if(!occupied) {
        const option = document.createElement('option');
        option.value = posId;
        option.textContent = posId;
        select.appendChild(option);
        emptyPositionsCount++;
      }
    }
    if(emptyPositionsCount === 0) {
      modalContent.innerHTML = '<p>Não há posições livres neste terminal.</p>';
      modalConfirmBtn.style.display = 'none';
    } else {
      modalContent.appendChild(select);
      modalConfirmBtn.style.display = '';
    }
    modalConfirmBtn.onclick = () => {
      const pos = select.value;
      moveAircraftToPosition(flight, pos);
      closeModal();
    };
    modalCancelBtn.onclick = () => closeModal();
    showModal();
  }

  function moveAircraftToPosition(flight, newPos) {
    if(!newPos) return;
    flight.position = newPos;
    renderPositions();
    renderFlightList();
    showSnackbar(`Aeronave ${flight.id} movida para ${newPos}`);
  }

  function showModal() {
    modalBackdrop.style.display = 'flex';
    modal.focus();
  }
  function closeModal() {
    modalBackdrop.style.display = 'none';
    modalConfirmBtn.onclick = null;
    modalCancelBtn.onclick = null;
  }

  // Render flight list com filtros e dropdown para status editável
  function renderFlightList() {
    flightList.innerHTML = '';
    const now = new Date();
    const checkedStatuses = statusFilters.filter(f=>f.checked).map(f=>f.value);

    // Clean up canceled flights older than 1h, reagende semanal e diario
    flights = flights.filter(f => {
      if(f.status === 'Cancelled' && f.cancelledTimestamp) {
        let elapsed = (Date.now() - f.cancelledTimestamp);
        if(elapsed > 3600000) {
          // Reagendar conforme frequência
          if(f.frequency === 'Diário') {
            f.status = 'Scheduled';
            f.cancelledTimestamp = null;
            // Ajustar landingTime e departureTime para o próximo dia
            let land = new Date(f.landingTime.getTime() + 24*3600*1000);
            let dep = new Date(f.departureTime.getTime() + 24*3600*1000);
            f.landingTime = land;
            f.departureTime = dep;
          } else if(f.frequency === 'Semanal') {
            // Incrementa a data para a próxima semana (7 dias)
            let land = new Date(f.landingTime.getTime() + 7*24*3600*1000);
            let dep = new Date(f.departureTime.getTime() + 7*24*3600*1000);
            f.landingTime = land;
            f.departureTime = dep;
            f.status = 'Scheduled';
            f.cancelledTimestamp = null;
          } else {
            // Remove voo sem frequência definida
            return false;
          }
        } else {
          // mantém voo cancelled visível por 1h
          return true;
        }
      }
      return true;
    });

    if(currentFlightTab === 'arrivals') {
      let filtered = flights.filter(f => f.type === 'landing' && checkedStatuses.includes(f.status));
      filtered = filtered.filter(f => {
        if(!f.landingTime) return false;
        const diffMinutes = (f.landingTime - now) / 60000;
        return diffMinutes <= 60 && diffMinutes >= -120;
      });
      filtered.sort((a,b) => a.landingTime - b.landingTime);
      const groups = groupBy(filtered, 'status');

      for(const status of checkedStatuses) {
        if(!groups[status]) continue;
        const heading = document.createElement('h3');
        heading.textContent = `${status} (${groups[status].length})`;
        heading.style.margin = '0 0 0.5rem 0';
        heading.style.fontWeight = '700';
        heading.style.color = getStatusColorClass(status, true);
        flightList.appendChild(heading);
        groups[status].forEach(flight => {
          flightList.appendChild(createFlightCard(flight));
        });
      }
    } else {
      let filtered = flights.filter(f => f.type === 'departure' && checkedStatuses.includes(f.status));
      filtered.sort((a,b) => (a.departureTime || 0) - (b.departureTime || 0));
      const groups = groupBy(filtered, 'status');
      for(const status of checkedStatuses) {
        if(!groups[status]) continue;
        const heading = document.createElement('h3');
        heading.textContent = `${status} (${groups[status].length})`;
        heading.style.margin = '0 0 0.5rem 0';
        heading.style.fontWeight = '700';
        heading.style.color = getStatusColorClass(status, true);
        flightList.appendChild(heading);
        groups[status].forEach(flight => {
          flightList.appendChild(createFlightCard(flight));
        });
      }
    }
  }

  function groupBy(array, key) {
    return array.reduce((acc, item) => {
      (acc[item[key]] = acc[item[key]] || []).push(item);
      return acc;
    }, {});
  }

  function getStatusColorClass(status, isHeading=false) {
    switch(status) {
      case 'Confirmed': return isHeading ? '#2563eb' : 'status-confirmed';
      case 'Delayed': return isHeading ? '#b91c1c' : 'status-delayed';
      case 'Cancelled': return isHeading ? '#6b7280' : 'status-cancelled';
      default: return isHeading ? '#6b7280' : '';
    }
  }

  // Cria card com dropdown para alterar status
  function createFlightCard(flight) {
    const card = document.createElement('article');
    card.className = 'flight-card';
    card.setAttribute('tabindex', '0');
    card.dataset.flightId = flight.id;
    card.title = `Voo: ${flight.id}\nCompanhia: ${flight.airline}\nAeronave: ${flight.aircraft}`;

    const header = document.createElement('div');
    header.className = 'flight-header';
    header.textContent = `${flight.id} - ${flight.airline}`;

    const info1 = document.createElement('div');
    info1.className = 'flight-info';
    info1.textContent = flight.aircraft + (flight.origin ? ` - Origem: ${flight.origin}` : '');

    const info2 = document.createElement('div');
    info2.className = 'flight-info';
    if(flight.type === 'landing' && flight.landingTime) {
      info2.textContent = `Pouso previsto: ${formatDateTime(flight.landingTime)}`;
    } else if(flight.type === 'departure' && flight.departureTime) {
      info2.textContent = `Decolagem prevista: ${formatDateTime(flight.departureTime)}`;
    }
    
    const statusLabel = document.createElement('span');
    statusLabel.className = 'flight-status';
    statusLabel.textContent = flight.status;
    if(flight.status === 'Confirmed') statusLabel.classList.add('status-confirmed');
    else if(flight.status === 'Delayed') statusLabel.classList.add('status-delayed');
    else if(flight.status === 'Cancelled') statusLabel.classList.add('status-cancelled');

    // Dropdown para alterar status
    const statusSelect = document.createElement('select');
    statusSelect.className = 'flight-status-select';
    ['Confirmed', 'Delayed', 'Cancelled'].forEach(s => {
      const option = document.createElement('option');
      option.value = s;
      option.textContent = s;
      if(flight.status === s) option.selected = true;
      statusSelect.appendChild(option);
    });
    statusSelect.title = 'Alterar status do voo';
    statusSelect.setAttribute('aria-label', `Alterar status do voo ${flight.id}`);
    statusSelect.addEventListener('change', (e) => {
      handleStatusChange(flight, e.target.value);
      // Atualizar label visual
      statusLabel.textContent = e.target.value;
      statusLabel.className = 'flight-status';
      if(e.target.value === 'Confirmed') statusLabel.classList.add('status-confirmed');
      else if(e.target.value === 'Delayed') statusLabel.classList.add('status-delayed');
      else if(e.target.value === 'Cancelled') statusLabel.classList.add('status-cancelled');
    });

    card.appendChild(header);
    card.appendChild(info1);
    card.appendChild(info2);
    card.appendChild(statusLabel);
    card.appendChild(statusSelect);

    return card;
  }

  // Formatar hora
  function formatDateTime(d) {
    if(!d) return '';
    return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  flightTabs.addEventListener('click', (evt) => {
    if(!evt.target.matches('button')) return;
    const sel = evt.target.id === 'tab-arrivals' ? 'arrivals' : 'departures';
    if(sel === currentFlightTab) return;
    document.querySelector('#flight-tabs button[aria-selected="true"]').setAttribute('aria-selected', 'false');
    evt.target.setAttribute('aria-selected', 'true');
    currentFlightTab = sel;
    setFlightListAriaLabel();
    renderFlightList();
  });

  function setFlightListAriaLabel() {
    const label = currentFlightTab === 'arrivals' ? 'Lista de voos de pouso' : 'Lista de voos de decolagem';
    flightList.setAttribute('aria-label', label);
  }
  setFlightListAriaLabel();

  // Quando altera status na dropdown
  function handleStatusChange(flight, newStatus) {
    const previousStatus = flight.status;
    flight.status = newStatus;

    if(newStatus === 'Confirmed') {
      // Mostrar popup para confirmar horário do pouso
      openConfirmLandingTimeModal(flight);
    } else if(newStatus === 'Delayed') {
      // Mostrar popup com horário do pouso para visualização
      openShowLandingTimeModal(flight);
    } else if(newStatus === 'Cancelled') {
      // Marcar o timestamp do cancelamento para controlar visibilidade
      flight.cancelledTimestamp = Date.now();
      showSnackbar(`Voo ${flight.id} cancelado. Ficar visível por 1h.`);
    }
    renderFlightList();
  }

  function openConfirmLandingTimeModal(flight) {
    modalTitle.textContent = `Confirmar horário de pouso - Voo ${flight.id}`;
    modalContent.innerHTML = '';
    // Input para editar horário de pouso, padrão no horário atual do voo
    const label = document.createElement('label');
    label.textContent = 'Horário previsto de pouso:';
    label.setAttribute('for', 'landing-time-input');
    const input = document.createElement('input');
    input.type = 'time';
    input.id = 'landing-time-input';
    input.value = formatTimeInput(flight.landingTime);
    input.min = '00:00';
    input.max = '23:59';
    modalContent.appendChild(label);
    modalContent.appendChild(input);

    modalConfirmBtn.onclick = () => {
      const val = input.value;
      if(val) {
        const [h,m] = val.split(':').map(Number);
        if(!isNaN(h) && !isNaN(m)) {
          const newLandingTime = new Date(flight.landingTime);
          newLandingTime.setHours(h,m,0,0);
          flight.landingTime = newLandingTime;
          showSnackbar(`Horário do pouso do voo ${flight.id} confirmado para ${formatDateTime(newLandingTime)}.`);
          closeModal();
          renderFlightList();
        }
      }
    };
    modalCancelBtn.onclick = () => {
      closeModal();
    };
    showModal();
  }

  function openShowLandingTimeModal(flight) {
    modalTitle.textContent = `Horário previsto de pouso - Voo ${flight.id}`;
    modalContent.innerHTML = '';
    const p = document.createElement('p');
    p.textContent = `Horário previsto de pouso: ${formatDateTime(flight.landingTime)}`;
    modalContent.appendChild(p);

    modalConfirmBtn.onclick = () => {
      closeModal();
    };
    modalCancelBtn.onclick = () => closeModal();
    showModal();
  }

  // Formatar para input type=time (hh:mm)
  function formatTimeInput(date) {
    if(!date) return '';
    const h = date.getHours().toString().padStart(2,'0');
    const m = date.getMinutes().toString().padStart(2,'0');
    return `${h}:${m}`;
  }

  // Outras funções mantidas do código anterior (finalizar pouso e decolagem, fila de pouso, etc.)
  function handleLandingSelection(flight) {
    if(landingQueue.find(f => f.id === flight.id)) {
      showSnackbar('Este voo já está na fila de pouso.');
      return;
    }
    const now = Date.now();
    if(flight.landingTime && now < flight.landingTime.getTime()) {
      showSnackbar('Ainda não chegou o horário para liberar o pouso deste voo.');
      return;
    }
    landingQueue.push(flight);
    showSnackbar(`Voo ${flight.id} adicionado na fila de pouso.`);
    processLandingQueue();
  }
  function processLandingQueue() {
    if(landingQueue.length === 0) return;
    const now = Date.now();
    if(now - lastLandingTime < 30000) {
      setTimeout(processLandingQueue, 5000);
      return;
    }
    const flight = landingQueue.shift();
    openRunwaySelectionModal(flight, 'landing');
  }
  function openRunwaySelectionModal(flight, type) {
    modalTitle.textContent = `Selecione a pista para ${type === 'landing' ? 'pouso do voo' : 'decolagem do voo'} ${flight.id}`;
    modalContent.innerHTML = '';
    const select = document.createElement('select');
    if(type === 'landing') {
      LANDING_RUNWAYS.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        select.appendChild(opt);
      });
    } else {
      const runway = DEPARTURE_RUNWAY_MAP[flight.terminal];
      const opt = document.createElement('option');
      opt.value = runway;
      opt.textContent = runway;
      select.appendChild(opt);
      select.disabled = true;
    }
    modalContent.appendChild(select);
    modalConfirmBtn.onclick = () => {
      const pista = select.value;
      closeModal();
      if(type==='landing') finalizeLanding(flight, pista);
      else finalizeTakeoff(flight, pista);
    };
    modalCancelBtn.onclick = () => {
      if(type==='landing') landingQueue.unshift(flight);
      closeModal();
    };
    showModal();
  }
  function finalizeLanding(flight, runway) {
    lastLandingTime = Date.now();
    flight.status = 'Landed';
    flight.regNumber = flight.regNumber || generateRegistrationNumber(flight);
    const terminalId = flight.terminal;
    const occupiedPositions = flights.filter(f => f.position && f.terminal===terminalId).map(f=>f.position);
    let freePos = null;
    for(let i=1; i<=POSITIONS_PER_TERMINAL; i++) {
      const posId = `${terminalId}-${String(i).padStart(2,'0')}`;
      if(!occupiedPositions.includes(posId)) {
        freePos = posId;
        break;
      }
    }
    flight.position = freePos;
    showSnackbar(`Voo ${flight.id} pousou na ${runway} e estacionou em ${freePos || 'posição não definida'}.`);
    renderPositions();
    renderFlightList();
  }
  function finalizeTakeoff(flight, runway) {
    flight.status = 'Finished';
    flight.position = null;
    flight.regNumber = null;
    showSnackbar(`Voo ${flight.id} decolou da ${runway}.`);
    renderPositions();
    renderFlightList();
  }
  function generateRegistrationNumber(flight) {
    const prefix = flight.airline.slice(0,3).toUpperCase();
    const timestamp = Date.now().toString().slice(-5);
    return `${prefix}${timestamp}`;
  }
  function periodicUpdate() {
    const now = Date.now();

    flights.forEach(f => {
      if(f.type === 'landing') {
        if(f.status === 'Scheduled' && f.landingTime - now <= 60*60000) {
          f.status = f.status === 'Cancelled' ? 'Cancelled' : 'Confirmed';
        }
      }
    });
    
    renderFlightList();

    if(landingQueue.length > 0) {
      processLandingQueue();
    }

    setTimeout(periodicUpdate, 10000);
  }
  function updateLocalTime() {
    const now = new Date();
    currentTimeEl.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second:'2-digit'});
  }
  function toggleTheme() {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    themeToggleBtn.setAttribute('aria-pressed', isDark);
    themeToggleBtn.textContent = isDark ? '☀️' : '🌙';
  }
  themeToggleBtn.addEventListener('click', toggleTheme);
  updateFlightsBtn.addEventListener('click', () => {
    showSnackbar('Lista de voos atualizada');
    renderFlightList();
  });
  statusFilters.forEach(chk => {
    chk.addEventListener('change', () => {
      renderFlightList();
    });
  });

  // Inicialização
  function init() {
    createTerminalTabs();
    renderPositions();
    renderFlightList();
    setFlightListAriaLabel();
    updateLocalTime();
    setInterval(updateLocalTime, 1000);
    periodicUpdate();
  }
  init();

</script>
</body>
</html>

