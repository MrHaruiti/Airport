<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Movimento do Aeroporto</title>
  <style>
    /* CSS Reset & base */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0; padding: 0; font-family: 'Poppins', sans-serif;
      background: #fff; color: #4b5563; /* neutral gray */
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    /* Container layout */
    #app-container {
      display: flex;
      flex: 1;
      max-width: 1200px;
      margin: auto;
      box-shadow: 0 6px 20px rgb(0 0 0 / 0.05);
      border-radius: 0.75rem;
      overflow: hidden;
      background: #fff;
    }
    /* Terminal Tabs */
    #terminal-tabs {
      display: flex;
      border-bottom: 2px solid #e5e7eb; /* light gray */
      background: #f9fafb;
      user-select: none;
    }
    #terminal-tabs button {
      flex: 1;
      padding: 1rem 0;
      font-weight: 700;
      font-size: 1.125rem;
      border: none;
      background: transparent;
      cursor: pointer;
      color: #6b7280;
      transition: color 0.3s ease, border-bottom-color 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    #terminal-tabs button[aria-selected="true"] {
      color: #111827;
      border-bottom-color: #3b82f6; /* blue */
    }
    #terminal-tabs button:hover:not([aria-selected="true"]) {
      color: #2563eb;
    }

    /* Terminal Content Area */
    #terminal-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      background: #fefefe;
    }
    /* Positions grid */
    .positions-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-gap: 1rem;
      padding: 1rem;
      overflow-y: auto;
      height: calc(100vh - 140px);
      background: #f3f4f6;
    }
    .position-card {
      background: #fff;
      border-radius: 0.75rem;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.07);
      padding: 0.5rem 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.875rem;
      color: #374151;
      user-select: none;
      cursor: pointer;
      transition: box-shadow 0.3s ease, transform 0.3s ease;
      position: relative;
    }
    .position-card:hover {
      box-shadow: 0 6px 20px rgb(0 0 0 / 0.12);
      transform: scale(1.04);
      z-index: 5;
    }
    .position-card .pos-label {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #111827;
    }
    .position-card .aircraft-id {
      font-weight: 700;
      font-size: 0.9rem;
      color: #2563eb;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 100%;
    }
    .position-empty {
      color: #9ca3af;
      font-style: italic;
    }

    /* Side panel */
    #side-panel {
      width: 320px;
      border-left: 1px solid #e5e7eb;
      background: #fff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #side-panel h2 {
      font-weight: 700;
      font-size: 1.25rem;
      padding: 1rem 1.5rem 0.5rem;
      color: #111827;
      user-select: none;
    }
    #flight-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      user-select: none;
    }
    #flight-tabs button {
      flex: 1;
      padding: 0.7rem 0;
      font-weight: 600;
      background: transparent;
      border: none;
      cursor: pointer;
      color: #6b7280;
      font-size: 1rem;
      letter-spacing: 0.03em;
      border-bottom: 3px solid transparent;
      transition: all 0.25s ease;
    }
    #flight-tabs button[aria-selected="true"] {
      color: #111827;
      border-bottom-color: #3b82f6;
      font-weight: 700;
    }
    #flight-tabs button:hover:not([aria-selected="true"]) {
      color: #2563eb;
    }
    #flight-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 1rem 1rem;
    }

    /* Flight card */
    .flight-card {
      background: #f9fafb;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.05);
      margin-bottom: 0.6rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    .flight-card:hover {
      background-color: #e0e7ff;
      box-shadow: 0 4px 10px rgb(59 130 246 / 0.25);
    }
    .flight-header {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      color: #111827;
      font-size: 1rem;
      user-select: text;
    }
    .flight-info {
      font-size: 0.875rem;
      color: #6b7280;
      margin-top: 0.2rem;
      user-select: text;
    }
    .flight-status {
      margin-top: 0.3rem;
      font-weight: 600;
      padding: 0.15rem 0.6rem;
      border-radius: 0.5rem;
      width: fit-content;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.03em;
    }
    .status-confirmed {
      background-color: #dbeafe;
      color: #2563eb;
    }
    .status-delayed {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    .status-cancelled {
      background-color: #f3f4f6;
      color: #6b7280;
      font-style: italic;
    }

    /* Modal backdrop */
    #modal-backdrop {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background-color: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    /* Modal content */
    #modal {
      background: #fff;
      border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgb(0 0 0 / 0.15);
      max-width: 400px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1.5rem;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    #modal h3 {
      margin: 0 0 1rem;
      font-weight: 700;
      font-size: 1.5rem;
      color: #111827;
      user-select: text;
    }
    #modal label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      user-select: text;
    }
    #modal select {
      width: 100%;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      transition: border-color 0.3s ease;
    }
    #modal select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    #modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1rem;
    }
    #modal-buttons button {
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 0.6rem 1.25rem;
      border-radius: 0.5rem;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.25s ease;
      user-select: none;
    }
    #modal-buttons button:hover {
      background-color: #2563eb;
    }
    #modal-buttons button.cancel-btn {
      background-color: #9ca3af;
    }
    #modal-buttons button.cancel-btn:hover {
      background-color: #6b7280;
    }

    /* Scrollbar for side panel and positions */
    #flight-list::-webkit-scrollbar,
    .positions-grid::-webkit-scrollbar {
      width: 6px;
    }
    #flight-list::-webkit-scrollbar-thumb,
    .positions-grid::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 3px;
    }

  </style>
</head>
<body>
  <div id="app-container" role="main" aria-label="Controle de Movimento do Aeroporto">
    <div style="flex:1; display:flex; flex-direction:column; min-width:0;">
      <nav id="terminal-tabs" role="tablist" aria-label="Terminais do aeroporto"></nav>
      <section id="terminal-content" tabindex="0"></section>
    </div>
    <aside id="side-panel" aria-label="Painel lateral de voos">
      <h2>Voos</h2>
      <nav id="flight-tabs" role="tablist" aria-label="Categorias de voos">
        <button role="tab" id="tab-arrivals" aria-controls="panel-arrivals" aria-selected="true" tabindex="0">Pousos</button>
        <button role="tab" id="tab-departures" aria-controls="panel-departures" aria-selected="false" tabindex="-1">Decolagens</button>
      </nav>
      <div id="flight-list" role="tabpanel" aria-labelledby="tab-arrivals" tabindex="0" style="overflow-y:auto;"></div>
    </aside>
  </div>

  <!-- Modal -->
  <div id="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div id="modal">
      <h3 id="modal-title"></h3>
      <div id="modal-content"></div>
      <div id="modal-buttons">
        <button id="modal-confirm-btn">Confirmar</button>
        <button id="modal-cancel-btn" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

<script>
  // Constants
  const TERMINAL_COUNT = 10;
  const POSITIONS_PER_TERMINAL = 36;
  const LANDING_RUNWAYS = ['Pista 1', 'Pista 2'];
  const DEPARTURE_RUNWAY_MAP = {
    'TPS1': 'Pista 1',
    'TPS2': 'Pista 1',
    'TPS3': 'Pista 1',
    'TPS4': 'Pista 1',
    'TPS5': 'Pista 1',
    'TPS6': 'Pista 2',
    'TPS7': 'Pista 2',
    'TPS8': 'Pista 2',
    'TPS9': 'Pista 2',
    'TPS10': 'Pista 2'
  };

  // Status flows (just for reference - can be used for validation or UI updates)
  const LANDING_STATUS = [
    'Scheduled','Confirmed','Landing','Landed','Deplaning','Finished',
    'Delayed','Cancelled'
  ];
  const DEPARTURE_STATUS = [
    'Scheduled','Check-in Opened','Boarding','Boarding Now','Last Call',
    'Confirmed','Taking Off','Finished',
    'Delayed','Cancelled'
  ];

  // Flight frequencies
  // Frequência diária ou semanal, data do voo será controlada via JS na demo

  // Data simulação
  // O ideal é carregar de planilha, mas aqui simularemos um pequeno conjunto para demonstração

  let flights = [
    // Pousos
    {id: 'AV101', airline:'Azul', aircraft:'Airbus A320', origin:'GRU', destination:'SBGR',
      terminal:'TPS1', position:null, // não estacionada ainda
      landingTime:new Date(Date.now() + 30*60000), // 30 min from now
      departureTime:new Date(Date.now() + 180*60000), // 3h from now
      frequency: 'Diário', type: 'landing',
      status: 'Scheduled',
      regNumber: null // aircraft registration after landing
    },
    {id: 'EM777', airline:'Emirates', aircraft:'B77W', origin:'DXB', destination:'SBGR',
      terminal:'TPS5', position:null,
      landingTime:new Date(Date.now() + 30*60000), // 30 min from now
      departureTime:new Date(Date.now() + 360*60000), // 6h from now
      frequency: 'Semanal', nextFlightDay: new Date(Date.now() + 7*24*3600*1000).getDay(), // weekly flight
      type: 'landing',
      status: 'Confirmed',
      regNumber: null
    },
    {id: 'JJ404', airline:'LATAM', aircraft:'B738', origin:'SCL', destination:'SBGR',
      terminal:'TPS9', position:null,
      landingTime:new Date(Date.now() + 10*60000), // 10 min from now
      departureTime:new Date(Date.now() + 150*60000), // 2.5h from now
      frequency: 'Diário',
      type: 'landing',
      status: 'Delayed',
      regNumber: null
    },
    {id: 'GOL221', airline:'Gol', aircraft:'B737', origin:'VCP', destination:'SBGR',
      terminal:'TPS3', position:null,
      landingTime:new Date(Date.now() + 90*60000), // 90 min from now
      departureTime:new Date(Date.now() + 210*60000), // 3.5h from now
      frequency: 'Diário',
      type: 'landing',
      status: 'Cancelled',
      regNumber: null
    },
    // Decolagens
    {id: 'AV101D', airline:'Azul', aircraft:'Airbus A320', origin:'SBGR', destination:'GRU',
      terminal:'TPS5', position:'TPS5-01',
      landingTime:null,
      departureTime:new Date(Date.now() + 40*60000), // 40 min from now
      frequency: 'Diário', type: 'departure',
      status: 'Scheduled',
      regNumber: 'REG1001'
    },
    {id: 'EM777D', airline:'Emirates', aircraft:'B77W', origin:'SBGR', destination:'DXB',
      terminal:'TPS6', position:'TPS6-05',
      landingTime:null,
      departureTime:new Date(Date.now() + 240*60000),
      frequency: 'Semanal',
      type: 'departure',
      status: 'Scheduled',
      regNumber: 'REG2002'
    }
  ];

  // State variables
  let currentTerminalIndex = 0;
  let currentFlightTab = 'arrivals'; // arrivals or departures
  let landingQueue = []; // Voos em espera para pousar, com gestão do intervalo 30s
  let lastLandingTime = 0; // timestamp do último pouso liberado
  
  // DOM elements
  const terminalTabs = document.getElementById('terminal-tabs');
  const terminalContent = document.getElementById('terminal-content');
  const flightTabs = document.getElementById('flight-tabs');
  const flightList = document.getElementById('flight-list');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalContent = document.getElementById('modal-content');
  const modalConfirmBtn = document.getElementById('modal-confirm-btn');
  const modalCancelBtn = document.getElementById('modal-cancel-btn');

  // Create tab buttons for terminals
  function createTerminalTabs() {
    for(let i=0; i<TERMINAL_COUNT; i++) {
      const btn = document.createElement('button');
      btn.textContent = `TPS${i+1}`;
      btn.setAttribute('role', 'tab');
      btn.setAttribute('aria-selected', i === currentTerminalIndex ? 'true' : 'false');
      btn.setAttribute('tabindex', i === currentTerminalIndex ? '0' : '-1');
      btn.id = `terminal-tab-${i}`;
      btn.dataset.index = i;
      btn.addEventListener('click', () => {
        switchTerminal(i);
      });
      terminalTabs.appendChild(btn);
    }
  }

  // Switch terminal tab handler
  function switchTerminal(index) {
    if(index === currentTerminalIndex) return;
    const prevBtn = terminalTabs.querySelector('[aria-selected="true"]');
    if(prevBtn) {
      prevBtn.setAttribute('aria-selected', 'false');
      prevBtn.setAttribute('tabindex', '-1');
    }
    const newBtn = terminalTabs.querySelector(`[data-index="${index}"]`);
    if(newBtn) {
      newBtn.setAttribute('aria-selected', 'true');
      newBtn.setAttribute('tabindex', '0');
      newBtn.focus();
    }
    currentTerminalIndex = index;
    renderPositions();
  }

  // Render all position cards for current terminal
  function renderPositions() {
    const terminalId = `TPS${currentTerminalIndex+1}`;
    terminalContent.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'positions-grid';
    // Filter flights currently on positions in this terminal (only departures or landed flights)
    const flightsInTerminal = flights.filter(f => f.position && f.terminal === terminalId);
    // Create positions 1 to 36
    for(let i=1; i<=POSITIONS_PER_TERMINAL; i++) {
      const posId = `${terminalId}-${String(i).padStart(2,'0')}`;
      const posCard = document.createElement('div');
      posCard.className = 'position-card';
      posCard.setAttribute('tabindex', '0');
      posCard.dataset.positionId = posId;
      posCard.innerHTML = `<div class="pos-label">${posId}</div>`;
      const flightOnPos = flightsInTerminal.find(f => f.position === posId);
      if(flightOnPos) {
        posCard.innerHTML += `<div class="aircraft-id">${flightOnPos.regNumber || flightOnPos.id}</div>`;
        posCard.title = `Aeronave: ${flightOnPos.aircraft}\nVoo: ${flightOnPos.id}\nStatus: ${flightOnPos.status}`;
      } else {
        posCard.classList.add('position-empty');
        posCard.innerHTML += `<div class="aircraft-id">Vazia</div>`;
        posCard.title = `Posição livre`;
      }
      posCard.addEventListener('click', () => {
        handlePositionClick(posCard, flightOnPos);
      });
      grid.appendChild(posCard);
    }
    terminalContent.appendChild(grid);
  }

  // Handle clicking on a position card (for moving aircraft)
  function handlePositionClick(posCard, flight) {
    if(flight) {
      // Show popup to move aircraft to another position - simplified
      openMoveAircraftModal(flight);
    } else {
      alert('Posição vazia');
    }
  }

  // Modal for moving aircraft to another position
  function openMoveAircraftModal(flight) {
    modalTitle.textContent = `Mover Aeronave - Voo ${flight.id}`;
    modalContent.innerHTML = '';
    const select = document.createElement('select');
    // List only empty positions on the current terminal
    const terminalId = `TPS${currentTerminalIndex+1}`;
    for(let i=1; i<=POSITIONS_PER_TERMINAL; i++) {
      const posId = `${terminalId}-${String(i).padStart(2,'0')}`;
      const occupied = flights.some(f => f.position === posId);
      if(!occupied) {
        const option = document.createElement('option');
        option.value = posId;
        option.textContent = posId;
        select.appendChild(option);
      }
    }
    if(select.options.length === 0) {
      modalContent.innerHTML = '<p>Não há posições livres neste terminal.</p>';
      modalConfirmBtn.style.display = 'none';
    } else {
      modalContent.appendChild(select);
      modalConfirmBtn.style.display = '';
    }
    modalConfirmBtn.onclick = () => {
      const pos = select.value;
      moveAircraftToPosition(flight, pos);
      closeModal();
    };
    modalCancelBtn.onclick = () => closeModal();
    showModal();
  }

  // Move aircraft to new position
  function moveAircraftToPosition(flight, newPos) {
    if(!newPos) return;
    flight.position = newPos;
    renderPositions();
    renderFlightList();
  }

  // Show modal
  function showModal() {
    modalBackdrop.style.display = 'flex';
  }
  // Close modal
  function closeModal() {
    modalBackdrop.style.display = 'none';
  }

  // Render flight list on side panel according to currentFlightTab and filters
  function renderFlightList() {
    flightList.innerHTML = '';
    const now = new Date();
    if(currentFlightTab === 'arrivals') {
      // Pousos: mostrar voos que irão pousar, 1h antes do horário previsto, status Confirmed, Delayed, Cancelled
      let filtered = flights.filter(f => f.type === 'landing' &&
        (f.status === 'Confirmed' || f.status === 'Delayed' || f.status === 'Cancelled'));
      // Mostrar apenas voos com horário de pouso dentro do intervalo 1h antes até o horário atual + 2h (para visualizar próximos)
      filtered = filtered.filter(f => {
        if(!f.landingTime) return false;
        const diffMinutes = (f.landingTime - now) / 60000;
        return diffMinutes <= 60 && diffMinutes >= -120;
      });
      // Ordenar por horário de pouso
      filtered.sort((a,b) => a.landingTime - b.landingTime);
      filtered.forEach(flight => {
        flightList.appendChild(createFlightCard(flight));
      });
    } else {
      // Decolagens
      let filtered = flights.filter(f => f.type === 'departure');
      filtered = filtered.filter(f => f.status !== 'Cancelled');
      filtered.sort((a,b) => (a.departureTime || 0) - (b.departureTime || 0));
      filtered.forEach(flight => {
        flightList.appendChild(createFlightCard(flight));
      });
    }
  }

  // Create flight card element
  function createFlightCard(flight) {
    const card = document.createElement('article');
    card.className = 'flight-card';
    card.setAttribute('tabindex', '0');
    card.dataset.flightId = flight.id;
    card.title = `Voo: ${flight.id}\nCompanhia: ${flight.airline}\nAeronave: ${flight.aircraft}`;

    const header = document.createElement('div');
    header.className = 'flight-header';
    header.textContent = `${flight.id} - ${flight.airline}`;

    const info1 = document.createElement('div');
    info1.className = 'flight-info';
    info1.textContent = flight.aircraft + (flight.origin ? ` - Origem: ${flight.origin}` : '');

    const info2 = document.createElement('div');
    info2.className = 'flight-info';
    if(flight.type === 'landing' && flight.landingTime) {
      info2.textContent = `Pouso previsto: ${formatDateTime(flight.landingTime)}`;
    } else if(flight.type === 'departure' && flight.departureTime) {
      info2.textContent = `Decolagem prevista: ${formatDateTime(flight.departureTime)}`;
    }
    
    const statusLabel = document.createElement('span');
    statusLabel.className = 'flight-status';
    statusLabel.textContent = flight.status;
    if(flight.status === 'Confirmed') statusLabel.classList.add('status-confirmed');
    else if(flight.status === 'Delayed') statusLabel.classList.add('status-delayed');
    else if(flight.status === 'Cancelled') statusLabel.classList.add('status-cancelled');

    card.appendChild(header);
    card.appendChild(info1);
    card.appendChild(info2);
    card.appendChild(statusLabel);

    // Add click handler to push landing flights into the queue if confirmed and time to land
    if(flight.type === 'landing' && flight.status === 'Confirmed') {
      card.addEventListener('click', () => {
        handleLandingSelection(flight);
      });
    }

    return card;
  }

  // Format date/time helper
  function formatDateTime(d) {
    if(!d) return '';
    return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  // Flight tab button handler
  flightTabs.addEventListener('click', (evt) => {
    if(!evt.target.matches('button')) return;
    const sel = evt.target.id === 'tab-arrivals' ? 'arrivals' : 'departures';
    if(sel === currentFlightTab) return;
    document.querySelector('#flight-tabs button[aria-selected="true"]').setAttribute('aria-selected', 'false');
    evt.target.setAttribute('aria-selected', 'true');
    currentFlightTab = sel;
    renderFlightList();
  });

  // Landing queue and control of interval 30s between landings
  function handleLandingSelection(flight) {
    // If flight already in queue, ignore
    if(landingQueue.find(f => f.id === flight.id)) {
      alert('Este voo já está na fila de pouso.');
      return;
    }
    // Check if time is close for landing (can land only at or after landingTime)
    const now = Date.now();
    if(flight.landingTime && now < flight.landingTime.getTime()) {
      alert('Ainda não chegou o horário para liberar o pouso deste voo.');
      return;
    }
    // Add to queue
    landingQueue.push(flight);
    alert(`Voo ${flight.id} adicionado na fila de pouso.`);

    // Attempt to process landing queue
    processLandingQueue();
  }

  // Process landing queue respecting interval 30s
  function processLandingQueue() {
    if(landingQueue.length === 0) return;
    const now = Date.now();
    if(now - lastLandingTime < 30000) {
      // ainda no intervalo de 30s
      setTimeout(processLandingQueue, 5000);
      return;
    }
    const flight = landingQueue.shift();
    // Abrir pop-up para seleção de pista de pouso
    openRunwaySelectionModal(flight, 'landing');
  }

  // Open runway selection for landing or takeoff
  function openRunwaySelectionModal(flight, type) {
    modalTitle.textContent = `Selecione a pista para ${type === 'landing' ? 'pouso do voo' : 'decolagem do voo'} ${flight.id}`;
    modalContent.innerHTML = '';
    const select = document.createElement('select');
    if(type === 'landing') {
      LANDING_RUNWAYS.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        select.appendChild(opt);
      });
    } else {
      // decolagem: pista baseada no terminal
      const runway = DEPARTURE_RUNWAY_MAP[flight.terminal];
      const opt = document.createElement('option');
      opt.value = runway;
      opt.textContent = runway;
      select.appendChild(opt);
      select.disabled = true;
    }
    modalContent.appendChild(select);
    modalConfirmBtn.onclick = () => {
      const pista = select.value;
      closeModal();
      if(type==='landing') {
        finalizeLanding(flight, pista);
      } else {
        finalizeTakeoff(flight, pista);
      }
    };
    modalCancelBtn.onclick = () => {
      // Cancelar pouso ou decolagem, re-add na fila se landing
      if(type==='landing') landingQueue.unshift(flight);
      closeModal();
    };
    showModal();
  }

  // Finaliza pouso (gera regNumber e posiciona no terminal)
  function finalizeLanding(flight, runway) {
    lastLandingTime = Date.now();
    flight.status = 'Landed';
    // Gera um número de registro único (simples incremental ou timestamp)
    flight.regNumber = flight.regNumber || generateRegistrationNumber(flight);
    // Posiciona a aeronave em primeira posição livre do terminal
    const terminalId = flight.terminal;
    const occupiedPositions = flights.filter(f => f.position && f.terminal===terminalId).map(f=>f.position);
    let freePos = null;
    for(let i=1; i<=POSITIONS_PER_TERMINAL; i++) {
      const posId = `${terminalId}-${String(i).padStart(2,'0')}`;
      if(!occupiedPositions.includes(posId)) {
        freePos = posId;
        break;
      }
    }
    if(freePos) {
      flight.position = freePos;
    } else {
      alert('Não há posições livres no terminal para estacionar a aeronave.');
      flight.position = null;
    }
    alert(`Voo ${flight.id} pousou na pista ${runway} e posicionou na ${flight.position || 'posição não definida'}. Número registro: ${flight.regNumber}`);
    renderPositions();
    renderFlightList();
  }

  // Finaliza decolagem (remove da posição e finaliza voo)
  function finalizeTakeoff(flight, runway) {
    flight.status = 'Finished';
    flight.position = null;
    flight.regNumber = null; // aeronave sai
    alert(`Voo ${flight.id} decolou da pista ${runway}.`);
    renderPositions();
    renderFlightList();
  }

  // Gerar número de registro de aeronave (simples incremental baseado em timestamp + código)
  function generateRegistrationNumber(flight) {
    const prefix = flight.airline.slice(0,3).toUpperCase();
    const timestamp = Date.now().toString().slice(-5);
    return `${prefix}${timestamp}`;
  }

  // Periodic update loop para simular o passar do tempo e alterações de status
  function periodicUpdate() {
    const now = Date.now();

    flights.forEach(f => {
      if(f.type === 'landing') {
        if(f.status === 'Scheduled' && f.landingTime - now <= 60*60000) {
          // Aproximação 1h para lista
          // atualizar status para Confirmed para demo (em ambiente real viria da planilha)
          f.status = f.status === 'Cancelled' ? 'Cancelled' : 'Confirmed';
        }
        if(f.status === 'Confirmed' && now >= f.landingTime.getTime()) {
          // Aqui poderíamos automaticamente avançar status caso queira
          // Exemplo: avançar para Landing e adicionar na fila
          // Se quiser auto-adicionar na fila, comente a linha abaixo.
          // handleLandingSelection(f);
        }
      }
      if(f.type === 'departure') {
        // Atualizações simuladas de status poderiam ser feitas aqui
      }
    });
    
    renderFlightList();

    // Reprocessar fila de pouso caso ela tenha itens e intervalo passado
    if(landingQueue.length > 0) {
      processLandingQueue();
    }

    setTimeout(periodicUpdate, 10000); // Atualizar a cada 10 segundos
  }

  // Inicializar UI e dados
  function init() {
    createTerminalTabs();
    renderPositions();
    renderFlightList();
    periodicUpdate();
  }

  init();

</script>
</body>
</html>

