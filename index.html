<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Controle de Movimento do Aeroporto</title>
<style>
  /* Reset & Base styles */
  *, *::before, *::after { box-sizing: border-box; }
  body {
    margin:0; padding:0;
    font-family: 'Poppins', sans-serif;
    background: #ffffff;
    color: #6b7280;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    transition: background-color 0.4s ease, color 0.4s ease;
  }
  body.dark {
    background: #1f2937;
    color: #d1d5db;
  }

  /* Header */
  header#app-header {
    position: sticky; top: 0; z-index: 10000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    background: #fff;
    color: #111827;
    font-weight: 800;
    font-size: 2rem;
    letter-spacing: 0.05em;
    user-select: none;
    transition: background-color 0.4s ease, color 0.4s ease;
  }
  body.dark header#app-header {
    background: #374151;
    color: #f3f4f6;
  }
  #logo { color: #3b82f6; user-select: text; }
  #header-title {
    flex-grow: 1;
    margin-left: 1rem;
    font-weight: 700;
    font-size: 2.25rem;
    user-select: text;
    color: inherit;
  }
  #header-actions {
    display: flex; align-items: center; gap: 1.5rem;
    font-weight: 600; font-size: 1.2rem; color: #6b7280;
  }
  body.dark #header-actions { color: #d1d5db; }
  #current-time { min-width: 120px; user-select: none; }
  button#theme-toggle {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.75rem;
    color: currentColor;
    transition: color 0.3s ease;
  }
  button#theme-toggle:hover { color: #2563eb; }

  /* Main container */
  #app-container {
    flex: 1;
    max-width: 1200px;
    margin: 2rem auto 3rem;
    background: #fff;
    border-radius: 0.75rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    display: flex;
    overflow: hidden;
    user-select: none;
    min-height: calc(100vh - 111px);
    transition: background-color 0.4s ease, color 0.4s ease;
  }
  body.dark #app-container { background: #111827; color: #d1d5db; }

  /* Terminal tabs */
  #terminal-tabs {
    display: flex;
    background: #f9fafb;
    border-bottom: 3px solid #e5e7eb;
    user-select: none;
  }
  body.dark #terminal-tabs { background: #374151; border-color: #4b5563; }
  #terminal-tabs button {
    flex: 1;
    padding: 1.3rem 0;
    font-weight: 700;
    font-size: 1.3rem;
    color: #6b7280;
    background: transparent;
    border: none;
    border-bottom: 4px solid transparent;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    transition: color 0.3s ease, border-color 0.3s ease;
    outline-offset: 4px;
  }
  #terminal-tabs button[aria-selected="true"] {
    color: #111827;
    border-bottom-color: #3b82f6;
    outline: none;
  }
  body.dark #terminal-tabs button[aria-selected="true"] {
    color: #d1d5db;
    border-bottom-color: #60a5fa;
  }
  #terminal-tabs button:hover:not([aria-selected="true"]) { color: #2563eb; }
  body.dark #terminal-tabs button:hover:not([aria-selected="true"]) { color: #93c5fd; }
  .tab-icon {
    stroke: currentColor;
    stroke-width: 1.8;
    width: 20px; height: 20px;
    user-select: none;
  }

  /* Terminal content */
  #terminal-content {
    flex: 1;
    padding: 1.5rem 1.75rem;
    background: #fefefe;
    overflow-y: auto;
    user-select: none;
    font-size: 1rem;
    display: flex;
    flex-direction: column;
    gap: 20px;
    transition: background-color 0.4s ease, color 0.4s ease;
  }
  body.dark #terminal-content { background: #1f2937; color: #d1d5db; }
  .positions-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 1.35rem;
  }
  .position-card {
    background: #fff;
    border-radius: 0.75rem;
    box-shadow: 0 3px 14px rgba(0,0,0,0.07);
    padding: 1rem;
    font-weight: 700;
    color: #374151;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: box-shadow 0.35s cubic-bezier(0.4,0,0.2,1), transform 0.3s ease;
    outline-offset: 5px;
    position: relative;
  }
  body.dark .position-card {
    background: #2563eb;
    color: #e0e7ff;
    box-shadow: 0 3px 16px rgba(96,165,250,0.7);
  }
  .position-card:hover, .position-card:focus-visible {
    box-shadow: 0 10px 32px rgba(59,130,246,0.35);
    transform: scale(1.07);
    outline: none;
    z-index: 999;
  }
  .position-empty {
    font-style: italic;
    color: #9ca3af;
    user-select: none;
  }
  body.dark .position-empty { color: #93c5fd; }
  .pos-label {
    font-size: 1.15rem;
    margin-bottom: 0.45rem;
    user-select: text;
    color: inherit;
  }
  .aircraft-id {
    font-size: 1.05rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    color: #2563eb;
    user-select: text;
  }
  body.dark .aircraft-id { color: #dbeafe; }

  /* Side panel */
  #side-panel {
    width: 360px;
    background: #fff;
    border-left: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    user-select: none;
    transition: background-color 0.4s ease, color 0.4s ease;
    font-size: 1rem;
  }
  body.dark #side-panel { background: #111827; border-color: #4b5563; color: #d1d5db; }
  #side-panel h2 {
    font-weight: 700;
    font-size: 1.75rem;
    padding: 1rem 1.5rem 0.5rem;
    color: inherit;
    user-select: text;
  }

  /* Flight tabs */
  #flight-tabs {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
    user-select: none;
  }
  body.dark #flight-tabs { border-color: #4b5563; }
  #flight-tabs button {
    flex: 1;
    padding: 0.85rem 0;
    font-weight: 600;
    border: none;
    background: transparent;
    font-size: 1.25rem;
    letter-spacing: 0.03em;
    cursor: pointer;
    color: #6b7280;
    border-bottom: 3px solid transparent;
    transition: color 0.3s ease, border-color 0.3s ease;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
  }
  #flight-tabs button[aria-selected="true"] {
    font-weight: 700;
    border-bottom-color: #3b82f6;
    color: #111827;
    outline-offset: 5px;
    outline: none;
  }
  body.dark #flight-tabs button[aria-selected="true"] {
    color: #dbeafe;
    border-bottom-color: #60a5fa;
  }
  #flight-tabs button:hover:not([aria-selected="true"]) { color: #2563eb; }
  body.dark #flight-tabs button:hover:not([aria-selected="true"]) { color: #93c5fd; }

  /* Update flights button */
  #update-flights-btn {
    margin-left: 1rem;
    background-color: #3b82f6;
    border: none;
    color: white;
    font-weight: 600;
    font-size: 1.05rem;
    padding: 0.55rem 1.3rem;
    border-radius: 0.5rem;
    cursor: pointer;
    user-select: none;
    align-self: center;
    transition: background-color 0.3s ease;
  }
  #update-flights-btn:hover, #update-flights-btn:focus-visible {
    background-color: #2563eb;
    outline: none;
  }
  body.dark #update-flights-btn {
    background-color: #60a5fa;
    color: #111827;
  }
  body.dark #update-flights-btn:hover, body.dark #update-flights-btn:focus-visible {
    background-color: #3b82f6;
  }

  /* Flight list */
  #flight-list {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 1.75rem 2rem;
    user-select: none;
  }
  .flight-card {
    background: #f9fafb;
    border-radius: 0.75rem;
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
    cursor: pointer;
    box-shadow: 0 6px 15px rgb(0 0 0 / 0.05);
    color: #374151;
    font-size: 1rem;
    user-select: text;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    outline-offset: 4px;
  }
  body.dark .flight-card {
    background: #2563eb;
    color: #e0e7ff;
    box-shadow: 0 9px 22px rgba(96, 165, 250, 0.7);
  }
  .flight-card:hover, .flight-card:focus-visible {
    background-color: #e0e7ff;
    color: #111827;
    box-shadow: 0 12px 30px rgba(59, 130, 246, 0.35);
    outline: none;
  }
  body.dark .flight-card:hover, body.dark .flight-card:focus-visible {
    background-color: #3b82f6;
    color: #fff;
    box-shadow: 0 14px 35px rgba(191, 219, 254, 0.85);
    outline: none;
  }
  .flight-header {
    display: flex;
    justify-content: space-between;
    font-weight: 700;
    color: inherit;
    font-size: 1.25rem;
    user-select: text;
  }
  .flight-info {
    margin-top: 0.35rem;
    color: #6b7280;
    font-size: 1rem;
    user-select: text;
  }
  body.dark .flight-info {
    color: #d1d5db;
  }
  .flight-status {
    margin-top: 0.5rem;
    display: inline-block;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 0.25rem 0.9rem;
    border-radius: 0.5rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    user-select: none;
  }
  .status-confirmed {
    background-color: #dbeafe;
    color: #2563eb;
  }
  body.dark .status-confirmed {
    background-color: #60a5fa;
    color: #fefefe;
  }
  .status-delayed {
    background-color: #fee2e2;
    color: #b91c1c;
  }
  body.dark .status-delayed {
    background-color: #fca5a5;
    color: #630000;
  }
  .status-cancelled {
    background-color: #f3f4f6;
    color: #6b7280;
    font-style: italic;
  }
  body.dark .status-cancelled {
    background-color: #4b5563;
    color: #9ca3af;
    font-style: italic;
  }
  .flight-status-select {
    margin-top: 0.5rem;
    padding: 0.25rem 0.5rem;
    width: 100%;
    max-width: 200px;
    border-radius: 0.5rem;
    border: 1px solid #d1d5db;
    font-family: 'Poppins', sans-serif;
    font-size: 0.9rem;
    color: #111827;
    cursor: pointer;
    user-select: text;
    transition: border-color 0.3s ease;
  }
  body.dark .flight-status-select {
    border-color: #60a5fa;
    background: #1e40af;
    color: #fefefe;
  }
  .flight-status-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
  }

  /* Modal backdrop */
  #modal-backdrop {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background-color: rgba(0,0,0,0.36);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    user-select: none;
    animation: fadein 0.32s ease forwards;
  }
  body.dark #modal-backdrop {
    background-color: rgba(0,0,0,0.5);
  }
  @keyframes fadein {
    from {opacity: 0;}
    to {opacity: 1;}
  }
  /* Modal content */
  #modal {
    background: #fff;
    border-radius: 0.75rem;
    max-width: 440px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    padding: 2rem 2.5rem;
    user-select: text;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    animation: slideup 0.4s cubic-bezier(0.4,0,0.2,1) forwards;
    outline: none;
  }
  body.dark #modal {
    background: #2563eb;
    color: #fefefe;
  }
  @keyframes slideup {
    from {opacity: 0; transform: translateY(20px);}
    to {opacity: 1; transform: translateY(0);}
  }
  #modal h3 {
    font-weight: 800;
    font-size: 1.6rem;
    margin: 0 0 1rem 0;
  }
  #modal label {
    font-weight: 600;
    margin-bottom: 0.75rem;
    display: block;
  }
  #modal select, #modal input[type="time"] {
    width: 100%;
    padding: 0.6rem;
    border-radius: 0.5rem;
    border: 1px solid #d1d5db;
    font-size: 1rem;
    font-family: 'Poppins', sans-serif;
    transition: border-color 0.3s ease;
    color: #111827;
    user-select: text;
  }
  body.dark #modal select, body.dark #modal input[type="time"] {
    border-color: #60a5fa;
    background: #1e40af;
    color: #fefefe;
  }
  #modal select:focus, #modal input[type="time"]:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.35);
  }
  #modal-buttons {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1rem;
  }
  #modal-buttons button {
    background-color: #3b82f6;
    color: white;
    border: none;
    padding: 0.7rem 1.6rem;
    font-weight: 700;
    border-radius: 0.5rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.25s ease;
  }
  #modal-buttons button.cancel-btn {
    background-color: #9ca3af;
  }
  #modal-buttons button:hover, #modal-buttons button:focus-visible {
    background-color: #2563eb;
    outline: none;
  }
  #modal-buttons button.cancel-btn:hover, #modal-buttons button.cancel-btn:focus-visible {
    background-color: #6b7280;
    outline: none;
  }

  /* Scrollbar custom */
  #flight-list::-webkit-scrollbar, .positions-grid::-webkit-scrollbar {
    width: 7px;
  }
  #flight-list::-webkit-scrollbar-thumb, .positions-grid::-webkit-scrollbar-thumb {
    background-color: #cbd5e1;
    border-radius: 4px;
  }
  body.dark #flight-list::-webkit-scrollbar-thumb, body.dark .positions-grid::-webkit-scrollbar-thumb {
    background-color: #60a5fa;
  }

  /* Snackbar */
  #snackbar {
    visibility: hidden;
    opacity: 0;
    position: fixed;
    left: 50%;
    bottom: 2rem;
    padding: 1rem 2rem;
    background-color: #2563eb;
    color: white;
    font-size: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 6px 20px rgba(37,99,235,0.6);
    transform: translateX(-50%);
    z-index: 12000;
    transition: visibility 0.5s, opacity 0.5s;
    user-select: none;
  }
  #snackbar.show {
    visibility: visible;
    opacity: 1;
  }
  body.dark #snackbar {
    background-color: #60a5fa;
    color: #111827;
    box-shadow: 0 6px 20px rgba(96,165,250,0.9);
  }
</style>
</head>
<body>

<header id="app-header" role="banner">
  <div id="logo" aria-label="Logo do Aeroporto">‚úàÔ∏è AeroControl</div>
  <div id="header-title" aria-level="1" role="heading">Controle de Movimento do Aeroporto</div>
  <div id="header-actions" aria-live="polite" aria-atomic="true">
    <div id="current-time" aria-label="Hor√°rio local"></div>
    <button id="theme-toggle" aria-pressed="false" aria-label="Alternar tema claro e escuro" title="Alternar tema claro e escuro">üåô</button>
  </div>
</header>

<div id="app-container" role="main" aria-label="Controle de Movimento do Aeroporto">
  <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
    <nav id="terminal-tabs" role="tablist" aria-label="Terminais do aeroporto"></nav>
    <section id="terminal-content" tabindex="0" aria-label="Posi√ß√µes do terminal"></section>
  </div>
  <aside id="side-panel" aria-label="Painel lateral de voos">
    <h2>Voos</h2>
    <nav id="flight-tabs" role="tablist" aria-label="Categorias de voos">
      <button role="tab" id="tab-arrivals" aria-controls="panel-arrivals" aria-selected="true" tabindex="0" aria-label="Mostrar voos de pouso">‚úàÔ∏è Pousos</button>
      <button role="tab" id="tab-departures" aria-controls="panel-departures" aria-selected="false" tabindex="-1" aria-label="Mostrar voos de decolagem">üõ´ Decolagens</button>
      <button id="update-flights-btn" type="button" aria-label="Atualizar lista de voos" title="Atualizar lista de voos">‚Üª Atualizar</button>
    </nav>
    <div id="side-panel-filters" aria-label="Filtros de status de voos" role="region">
      <label><input type="checkbox" name="status-filter" value="Confirmed" checked> Confirmed</label>
      <label><input type="checkbox" name="status-filter" value="Delayed" checked> Delayed</label>
      <label><input type="checkbox" name="status-filter" value="Cancelled"> Cancelled</label>
    </div>
    <div id="flight-list" role="tabpanel" aria-labelledby="tab-arrivals" tabindex="0"></div>
  </aside>
</div>

<!-- Modal -->
<div id="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div id="modal" tabindex="-1">
    <h3 id="modal-title"></h3>
    <div id="modal-content"></div>
    <div id="modal-buttons">
      <button id="modal-confirm-btn">Confirmar</button>
      <button id="modal-cancel-btn" class="cancel-btn">Cancelar</button>
    </div>
  </div>
</div>

<!-- Snackbar -->
<div id="snackbar" role="alert" aria-live="assertive" aria-atomic="true"></div>

<script>
  'use strict';

  const TERMINAL_COUNT = 10;
  const POSITIONS_PER_TERMINAL = 36;
  const LANDING_RUNWAYS = ['Pista 1', 'Pista 2'];
  const DEPARTURE_RUNWAY_MAP = {
    'TPS1': 'Pista 1','TPS2': 'Pista 1','TPS3': 'Pista 1','TPS4': 'Pista 1','TPS5': 'Pista 1',
    'TPS6': 'Pista 2','TPS7': 'Pista 2','TPS8': 'Pista 2','TPS9': 'Pista 2','TPS10': 'Pista 2'
  };

  let flights = [
    // Seu array de voo aqui, pode inicializar vazio e usar fetch para carregar seu JSON
  ];

  let currentTerminalIndex = 0;
  let currentFlightTab = 'arrivals'; // 'arrivals' or 'departures'
  let landingQueue = [];
  let lastLandingTime = 0;

  const terminalTabs = document.getElementById('terminal-tabs');
  const terminalContent = document.getElementById('terminal-content');
  const flightTabs = document.getElementById('flight-tabs');
  const flightList = document.getElementById('flight-list');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalContent = document.getElementById('modal-content');
  const modalConfirmBtn = document.getElementById('modal-confirm-btn');
  const modalCancelBtn = document.getElementById('modal-cancel-btn');
  const snackbar = document.getElementById('snackbar');
  const themeToggleBtn = document.getElementById('theme-toggle');
  const currentTimeEl = document.getElementById('current-time');
  const updateFlightsBtn = document.getElementById('update-flights-btn');
  const statusFilters = [...document.querySelectorAll('#side-panel-filters input[type=checkbox]')];

  // √çcones
  const icons = {
    terminal: `<svg aria-hidden="true" class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20"><rect x="2" y="4" width="20" height="16" rx="2" ry="2"/><path d="M8 8h8M8 12h8M8 16h8"/></svg>`
  };

  // Carrega dados do JSON do GitHub
  const FLIGHTS_JSON_URL = 'https://raw.githubusercontent.com/MrHaruiti/Airport/refs/heads/main/backup_voos.json';

  function showSnackbar(message) {
    snackbar.textContent = message;
    snackbar.classList.add('show');
    setTimeout(() => snackbar.classList.remove('show'), 3500);
  }

  function createTerminalTabs() {
    terminalTabs.innerHTML = '';
    for(let i=0; i < TERMINAL_COUNT; i++) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.innerHTML = `${icons.terminal} TPS${i+1}`;
      btn.setAttribute('role', 'tab');
      btn.setAttribute('aria-selected', i === currentTerminalIndex ? 'true' : 'false');
      btn.setAttribute('tabindex', i === currentTerminalIndex ? '0' : '-1');
      btn.id = `terminal-tab-${i}`;
      btn.dataset.index = i;
      btn.addEventListener('click', () => switchTerminal(i));
      terminalTabs.appendChild(btn);
    }
  }

  function switchTerminal(index) {
    if(index === currentTerminalIndex) return;
    const prevBtn = terminalTabs.querySelector('[aria-selected="true"]');
    if(prevBtn) {
      prevBtn.setAttribute('aria-selected', 'false');
      prevBtn.setAttribute('tabindex', '-1');
    }
    const newBtn = terminalTabs.querySelector(`[data-index="${index}"]`);
    if(newBtn) {
      newBtn.setAttribute('aria-selected', 'true');
      newBtn.setAttribute('tabindex', '0');
      newBtn.focus();
    }
    currentTerminalIndex = index;
    renderPositions();
  }

  function renderPositions() {
    const terminalId = `TPS${currentTerminalIndex+1}`;
    terminalContent.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'positions-grid';
    const flightsInTerminal = flights.filter(f => f.position && f.terminal === terminalId);
    for(let i=1; i<=POSITIONS_PER_TERMINAL; i++) {
      const posId = `${terminalId}-${String(i).padStart(2,'0')}`;
      const posCard = document.createElement('div');
      posCard.className = 'position-card';
      posCard.setAttribute('tabindex', '0');
      posCard.dataset.positionId = posId;
      posCard.innerHTML = `<div class="pos-label">${posId}</div>`;
      const flightOnPos = flightsInTerminal.find(f => f.position === posId);
      if(flightOnPos) {
        posCard.innerHTML += `<div class="aircraft-id">${flightOnPos.regNumber || flightOnPos.id || flightOnPos.aircraft}</div>`;
        posCard.title = `Aeronave: ${flightOnPos.aircraft}\nVoo: ${flightOnPos.number}\nStatus: ${flightOnPos.status}`;
      } else {
        posCard.classList.add('position-empty');
        posCard.innerHTML += `<div class="aircraft-id">Vazia</div>`;
        posCard.title = `Posi√ß√£o livre`;
      }
      posCard.addEventListener('click', () => { 
        if(flightOnPos) openMoveAircraftModal(flightOnPos);
        else showSnackbar('Posi√ß√£o vazia selecionada'); 
      });
      grid.appendChild(posCard);
    }
    terminalContent.appendChild(grid);
  }

  updateFlightsBtn.addEventListener('click', () => {
    loadFlightsData();
  });

  statusFilters.forEach(chk => {
    chk.addEventListener('change', () => {
      renderFlightList();
    });
  });

  flightTabs.addEventListener('click', (evt) => {
    if(!evt.target.matches('button')) return;
    const sel = evt.target.id === 'tab-arrivals' ? 'arrivals' : 'departures';
    if(sel === currentFlightTab) return;
    document.querySelector('#flight-tabs button[aria-selected="true"]').setAttribute('aria-selected', 'false');
    evt.target.setAttribute('aria-selected', 'true');
    currentFlightTab = sel;
    setFlightListAriaLabel();
    renderFlightList();
  });

  function setFlightListAriaLabel() {
    const label = currentFlightTab === 'arrivals' ? 'Lista de voos de pouso' : 'Lista de voos de decolagem';
    flightList.setAttribute('aria-label', label);
  }
  setFlightListAriaLabel();

  function renderFlightList() {
    flightList.innerHTML = '';
    const now = new Date();
    const checkedStatuses = statusFilters.filter(f=>f.checked).map(f=>f.value);

    // Cleanup cancelled flights older than 1h, reschedule daily/weekly cancelled flights
    flights = flights.filter(f => {
      if(f.status === 'Cancelled' && f.cancelledTimestamp) {
        let elapsed = (Date.now() - f.cancelledTimestamp);
        if(elapsed > 3600000) {
          if(f.frequency === 'Di√°rio') {
            f.status = 'Scheduled';
            f.cancelledTimestamp = null;
            if(f.landingTime) f.landingTime = new Date(f.landingTime.getTime() + 24*3600*1000);
            if(f.departureTime) f.departureTime = new Date(f.departureTime.getTime() + 24*3600*1000);
            return true;
          } else if(f.frequency === 'Semanal') {
            f.status = 'Scheduled';
            f.cancelledTimestamp = null;
            if(f.landingTime) f.landingTime = new Date(f.landingTime.getTime() + 7*24*3600*1000);
            if(f.departureTime) f.departureTime = new Date(f.departureTime.getTime() + 7*24*3600*1000);
            return true;
          }
          return false;
        }
        return true;
      }
      return true;
    });

    if(currentFlightTab === 'arrivals') {
      let filtered = flights.filter(f => f.type === 'landing' && checkedStatuses.includes(f.status));
      filtered = filtered.filter(f => {
        if(!f.landingTime) return false;
        const diffMinutes = (f.landingTime - now) / 60000;
        return diffMinutes <= 60 && diffMinutes >= -120;
      });
      filtered.sort((a,b) => a.landingTime - b.landingTime);
      const groups = groupBy(filtered, 'status');

      for(const status of checkedStatuses) {
        if(!groups[status]) continue;
        const heading = document.createElement('h3');
        heading.textContent = `${status} (${groups[status].length})`;
        heading.style.margin = '0 0 0.5rem 0';
        heading.style.fontWeight = '700';
        heading.style.color = getStatusColorClass(status, true);
        flightList.appendChild(heading);
        groups[status].forEach(flight => {
          flightList.appendChild(createFlightCard(flight));
        });
      }
    } else {
      let filtered = flights.filter(f => f.type === 'departure' && checkedStatuses.includes(f.status));
      filtered.sort((a,b) => (a.departureTime || 0) - (b.departureTime || 0));
      const groups = groupBy(filtered, 'status');
      for(const status of checkedStatuses) {
        if(!groups[status]) continue;
        const heading = document.createElement('h3');
        heading.textContent = `${status} (${groups[status].length})`;
        heading.style.margin = '0 0 0.5rem 0';
        heading.style.fontWeight = '700';
        heading.style.color = getStatusColorClass(status, true);
        flightList.appendChild(heading);
        groups[status].forEach(flight => {
          flightList.appendChild(createFlightCard(flight));
        });
      }
    }
  }

  function groupBy(array, key) {
    return array.reduce((acc, item) => {
      (acc[item[key]] = acc[item[key]] || []).push(item);
      return acc;
    }, {});
  }

  function getStatusColorClass(status, isHeading=false) {
    switch(status) {
      case 'Confirmed': return isHeading ? '#2563eb' : 'status-confirmed';
      case 'Delayed': return isHeading ? '#b91c1c' : 'status-delayed';
      case 'Cancelled': return isHeading ? '#6b7280' : 'status-cancelled';
      default: return isHeading ? '#6b7280' : '';
    }
  }

  // Creates flight card with editable status dropdown
  function createFlightCard(flight) {
    const card = document.createElement('article');
    card.className = 'flight-card';
    card.setAttribute('tabindex', '0');
    card.dataset.flightId = flight.id;
    card.title = `Voo: ${flight.number}\nCompanhia: ${flight.airline}\nAeronave: ${flight.aircraft}`;

    const header = document.createElement('div');
    header.className = 'flight-header';
    header.textContent = `${flight.number} - ${flight.airline}`;

    const info1 = document.createElement('div');
    info1.className = 'flight-info';
    info1.textContent = flight.aircraft + (flight.origin ? ` - Origem: ${flight.origin}` : '');

    const info2 = document.createElement('div');
    info2.className = 'flight-info';
    if(flight.type === 'landing' && flight.landingTime) {
      info2.textContent = `Pouso previsto: ${formatDateTime(flight.landingTime)}`;
    } else if(flight.type === 'departure' && flight.departureTime) {
      info2.textContent = `Decolagem prevista: ${formatDateTime(flight.departureTime)}`;
    }

    const statusLabel = document.createElement('span');
    statusLabel.className = 'flight-status';
    statusLabel.textContent = flight.status;
    if(flight.status === 'Confirmed') statusLabel.classList.add('status-confirmed');
    else if(flight.status === 'Delayed') statusLabel.classList.add('status-delayed');
    else if(flight.status === 'Cancelled') statusLabel.classList.add('status-cancelled');

    // Dropdown to change status
    const statusSelect = document.createElement('select');
    statusSelect.className = 'flight-status-select';
    ['Confirmed', 'Delayed', 'Cancelled'].forEach(s => {
      const option = document.createElement('option');
      option.value = s;
      option.textContent = s;
      if(flight.status === s) option.selected = true;
      statusSelect.appendChild(option);
    });
    statusSelect.title = 'Alterar status do voo';
    statusSelect.setAttribute('aria-label', `Alterar status do voo ${flight.number}`);
    statusSelect.addEventListener('change', (e) => {
      handleStatusChange(flight, e.target.value);
      statusLabel.textContent = e.target.value;
      statusLabel.className = 'flight-status';
      if(e.target.value === 'Confirmed') statusLabel.classList.add('status-confirmed');
      else if(e.target.value === 'Delayed') statusLabel.classList.add('status-delayed');
      else if(e.target.value === 'Cancelled') statusLabel.classList.add('status-cancelled');
    });

    card.appendChild(header);
    card.appendChild(info1);
    card.appendChild(info2);
    card.appendChild(statusLabel);
    card.appendChild(statusSelect);

    return card;
  }

  function formatDateTime(d) {
    if(!d) return '';
    return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  function handleStatusChange(flight, newStatus) {
    flight.status = newStatus;

    if(newStatus === 'Confirmed') {
      openConfirmLandingTimeModal(flight);
    } else if(newStatus === 'Delayed') {
      openShowLandingTimeModal(flight);
    } else if(newStatus === 'Cancelled') {
      flight.cancelledTimestamp = Date.now();
      showSnackbar(`Voo ${flight.number} cancelado. Ficar vis√≠vel por 1h.`);
    }
    renderFlightList();
  }

  // Modal for confirming landing time
  function openConfirmLandingTimeModal(flight) {
    modalTitle.textContent = `Confirmar hor√°rio de pouso - Voo ${flight.number}`;
    modalContent.innerHTML = '';
    const label = document.createElement('label');
    label.textContent = 'Hor√°rio previsto de pouso:';
    label.setAttribute('for', 'landing-time-input');
    const input = document.createElement('input');
    input.type = 'time';
    input.id = 'landing-time-input';
    input.value = formatTimeInput(flight.landingTime);
    input.min = '00:00';
    input.max = '23:59';
    modalContent.appendChild(label);
    modalContent.appendChild(input);

    modalConfirmBtn.onclick = () => {
      const val = input.value;
      if(val) {
        const [h,m] = val.split(':').map(Number);
        if(!isNaN(h) && !isNaN(m)) {
          const newLandingTime = new Date(flight.landingTime);
          newLandingTime.setHours(h,m,0,0);
          flight.landingTime = newLandingTime;
          showSnackbar(`Hor√°rio do pouso do voo ${flight.number} confirmado para ${formatDateTime(newLandingTime)}.`);
          closeModal();
          renderFlightList();
        }
      }
    };
    modalCancelBtn.onclick = () => closeModal();
    showModal();
  }

  // Modal to show landing time when delayed
  function openShowLandingTimeModal(flight) {
    modalTitle.textContent = `Hor√°rio previsto de pouso - Voo ${flight.number}`;
    modalContent.innerHTML = '';
    const p = document.createElement('p');
    p.textContent = `Hor√°rio previsto de pouso: ${formatDateTime(flight.landingTime)}`;
    modalContent.appendChild(p);

    modalConfirmBtn.onclick = () => {
      closeModal();
    };
    modalCancelBtn.onclick = () => closeModal();
    showModal();
  }

  function formatTimeInput(date) {
    if(!date) return '';
    const h = date.getHours().toString().padStart(2,'0');
    const m = date.getMinutes().toString().padStart(2,'0');
    return `${h}:${m}`;
  }

  // Modal show/hide
  function showModal() {
    modalBackdrop.style.display = 'flex';
    modal.focus();
  }
  function closeModal() {
    modalBackdrop.style.display = 'none';
    modalConfirmBtn.onclick = null;
    modalCancelBtn.onclick = null;
  }

  // Periodic updates for landing queue
  function periodicUpdate() {
    const now = Date.now();

    if(landingQueue.length > 0) {
      processLandingQueue();
    }
    renderFlightList();
    setTimeout(periodicUpdate, 10000);
  }

  function processLandingQueue() {
    if(landingQueue.length === 0) return;
    const now = Date.now();
    if(now - lastLandingTime < 30000) {
      setTimeout(processLandingQueue, 5000);
      return;
    }
    const flight = landingQueue.shift();
    openRunwaySelectionModal(flight, 'landing');
  }

  // Runway selection modal
  function openRunwaySelectionModal(flight, type) {
    modalTitle.textContent = `Selecione a pista para ${type === 'landing' ? 'pouso do voo' : 'decolagem do voo'} ${flight.number}`;
    modalContent.innerHTML = '';
    const select = document.createElement('select');
    if(type === 'landing') {
      LANDING_RUNWAYS.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        select.appendChild(opt);
      });
    } else {
      const runway = DEPARTURE_RUNWAY_MAP[flight.terminal];
      const opt = document.createElement('option');
      opt.value = runway;
      opt.textContent = runway;
      select.appendChild(opt);
      select.disabled = true;
    }
    modalContent.appendChild(select);
    modalConfirmBtn.onclick = () => {
      const pista = select.value;
      closeModal();
      if(type==='landing') finalizeLanding(flight, pista);
      else finalizeTakeoff(flight, pista);
    };
    modalCancelBtn.onclick = () => {
      if(type==='landing') landingQueue.unshift(flight);
      closeModal();
    };
    showModal();
  }

  // Finalize landing: assign position and regNumber
  function finalizeLanding(flight, runway) {
    lastLandingTime = Date.now();
    flight.status = 'Landed';
    flight.regNumber = flight.regNumber || generateRegNumber(flight);
    const terminalId = flight.terminal;
    const occupiedPositions = flights.filter(f => f.position && f.terminal === terminalId).map(f => f.position);
    let freePos = null;
    for(let i=1; i<=POSITIONS_PER_TERMINAL; i++) {
      const posId = `${terminalId}-${String(i).padStart(2,'0')}`;
      if(!occupiedPositions.includes(posId)) {
        freePos = posId;
        break;
      }
    }
    flight.position = freePos;
    showSnackbar(`Voo ${flight.number} pousou na ${runway} e estacionou em ${freePos || 'posi√ß√£o n√£o definida'}.`);
    renderPositions();
    renderFlightList();
  }

  // Finalize takeoff: clear position and regNumber
  function finalizeTakeoff(flight, runway) {
    flight.status = 'Finished';
    flight.position = null;
    flight.regNumber = null;
    showSnackbar(`Voo ${flight.number} decolou da ${runway}.`);
    renderPositions();
    renderFlightList();
  }

  // Simple regNumber generator
  function generateRegNumber(flight) {
    const prefix = (flight.airline || 'XXX').substring(0, 3).toUpperCase();
    const suffix = Date.now().toString().slice(-5);
    return `${prefix}${suffix}`;
  }

  // Handle landing queue addition with validation
  function handleLandingSelection(flight) {
    if(landingQueue.some(f => f.number === flight.number)) {
      showSnackbar('Este voo j√° est√° na fila de pouso.');
      return;
    }
    const now = Date.now();
    if(flight.landingTime && now < flight.landingTime.getTime()) {
      showSnackbar('Ainda n√£o chegou o hor√°rio para liberar o pouso deste voo.');
      return;
    }
    landingQueue.push(flight);
    showSnackbar(`Voo ${flight.number} adicionado na fila de pouso.`);
    processLandingQueue();
  }

  // Format time for input
  function formatTimeInput(date) {
    if(!date) return '';
    const h = date.getHours().toString().padStart(2,'0');
    const m = date.getMinutes().toString().padStart(2,'0');
    return `${h}:${m}`;
  }

  // Update local time display
  function updateLocalTime() {
    const now = new Date();
    currentTimeEl.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second:'2-digit'});
  }

  // Theme toggle button event
  themeToggleBtn.addEventListener('click', () => {
    const isDark = document.body.classList.toggle('dark');
    themeToggleBtn.setAttribute('aria-pressed', isDark);
    themeToggleBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  });

  // Load flights from provided GitHub JSON URL
  function loadFlightsData() {
    showSnackbar('Carregando lista de voos...');
    fetch(FLIGHTS_JSON_URL)
      .then(res => {
        if(!res.ok) throw new Error(`Erro ${res.status}`);
        return res.json();
      })
      .then(data => {
        if (!Array.isArray(data)) throw new Error('JSON recebido n√£o √© um array');
        flights = data.map(f => {
          f.landingTime = f.landingTime ? new Date(f.landingTime) : null;
          f.departureTime = f.departureTime ? new Date(f.departureTime) : null;
          f.frequency = f.frequency || null;
          f.position = f.position || null;
          f.regNumber = f.regNumber || generateRegNumber(f);
          f.status = 'Scheduled';
          f.cancelledTimestamp = null;
          f.type = f.type || (f.landingTime ? 'landing' : 'departure');
          f.number = f.number || f.id || 'UNK';
          f.terminal = f.terminal || (f.position ? f.position.split('-')[0] : null);
          return f;
        });
        createTerminalTabs();
        renderPositions();
        renderFlightList();
        showSnackbar('Lista de voos carregada com sucesso.');
      })
      .catch(err => {
        showSnackbar(`Falha ao carregar voos: ${err.message}`);
      });
  }

  // Initialize app
  function init() {
    createTerminalTabs();
    setFlightListAriaLabel();
    updateLocalTime();
    setInterval(updateLocalTime, 1000);
    loadFlightsData();
    periodicUpdate();
  }

  function setFlightListAriaLabel() {
    const label = currentFlightTab === 'arrivals' ? 'Lista de voos de pouso' : 'Lista de voos de decolagem';
    flightList.setAttribute('aria-label', label);
  }

  init();


</script>
</body>
</html>
